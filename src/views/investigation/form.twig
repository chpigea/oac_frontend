{% set showSidebar = true %}
{% extends "../base.twig" %}

{% block extendHead %}
    <script src="/{{ root }}/js/lib/shacl-form.bundle.js" type="module"></script>
    <script src="/{{ root }}/js/app/vue-autocomplete-component.js"></script>
    <script src="/{{ root }}/js/app/vue-investigation.js"></script>


  <style>
    /* Sfondo fullscreen semi-trasparente */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6); /* nero ombreggiato */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        visibility: visible;
        transition: opacity 0.3s ease;
    }

    /* Box centrale della modale */
    .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 650px;
        width: 90%;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
    }

    /* Label */
    .modal-content label {
        font-weight: bold;
    }

    /* Dropdown a 2 colonne */
    .modal-content select {
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr; /* 2 colonne */
        gap: 10px;
        padding: 5px;
        font-size: 16px;
    }

    /* Bottone chiusura */
    .close-btn {
        align-self: flex-end;
        background: transparent;
        border: none;
        font-size: 40px;
        cursor: pointer;
        float: right;
    }
  </style>
    
{% endblock %}

{% block content %}
    
    <div>
        <h2 style="display:flex; justify-content:space-between; align-items:center;">    
            <span>{{ t('investigation.title') }}:</span>
        </h2>
    </div>

    <div id="investigation-search"
      data-label_edit="{{ t('investigation.edit_item') }}"
      data-label_new="{{ t('investigation.new_item') }}"
      data-label_search="{{ t('investigation.search') }}"
      data-label_stop_edit="{{ t('investigation.stop_edit') }}"
      data-label_edit_from_other_user="{{ t('investigation.edit_from_other_user') }}" 
    ></div>

    <div v-cloak id="investigation-app"
      data-cur_role="{{ user.role }}"
      data-uuid="{{ uuid }}"
      data-editing="{{ user.role != 3 }}"
    >
      <template v-if="isVisible">
      
        {% if user.role != 3 %}
          <!-- Buttons -->
          <div class="col-12 text-center mt-4">
              <button style="margin-left:30px;" title="{{ t('investigation.new.download') }}"
                @click="download('xml')" type="button" class="btn btn-secondary">
                  <span>RDF/XML</span><i class="fa-solid fa-file-arrow-down"></i>
              </button>
              <button style="margin-left:30px;" title="{{ t('investigation.new.download') }}"
                @click="download('ttl')" type="button" class="btn btn-secondary">
                  <span>TURTLE</span><i class="fa-solid fa-file-arrow-down"></i>
              </button>
              <button v-if="inEditing && validForm" :disabled="saving" style="margin-left:30px;" title="{{ t('investigation.new.confirm') }}"
                @click="save(false)" type="button" :class="['btn', saving ? 'btn-secondary' : 'btn-primary']">
                <i v-if="saving"class="fa-solid fa-spinner"></i>
                <i v-else class="fa-solid fa-save"></i>
              </button>
              <!--
              <button style="margin-left:30px;" title="{{ t('investigation.new.reset') }}"
                @click="reset()" type="button" class="btn btn-info">
                <i class="fa-solid fa-broom"></i>
              </button>
              -->
          </div>

          <div id="shacl-container" 
            style="margin-top:10px; border:dashed 2px gray; padding:10px; border-radius:5px;">
            <shacl-form id="shacl-form" data-collapse="open"
                data-values-namespace="indagine:"
                data-shapes-url="/backend/ontology/schema/editing"
                data-generate-node-shape-reference=""
              ></shacl-form>
          </div>
          
          {% if user.role in [0, 1] %}
            <fieldset v-if="inEditing" id="shacl-output" style="margin-top:10px;
                border: solid 1px gray;
                border-radius: 10px;
                padding: 10px;">
              <legend>{{ t('investigation.new.generated_output') }}: 
                [{@ validForm ? '{{ t('investigation.new.valid') }}': '{{ t('investigation.new.not_valid') }}' @}]
              </legend>
              <pre :style="outputStyle">{@ serializedForm @}</pre>
            </fieldset>
          {% endif %}
        {% endif %}

        <div style="margin-top:200px;"></div>

        <div class="modal-overlay" v-cloak v-if="search.input != null">
          <div class="modal-content">
              <div class="row" style="line-height:40px; margin-bottom:10px;">
                <span style="font-weight:bold; float:left; max-width:570px;">
                  {{ t('investigation.new.select_instance') }}:
                </span>
                <span style="float:right; max-width:24px;" class="close-btn" @click="searchByPrefixStart(null, null);">&times;</span>            
              </div>
              <select size="10" v-model="search.selected">
                  <option v-for="item in search.results" :value="item">{@ (item.label && item.label.trim()) ? item.label : item.instance @}</option>
              </select>
              <div v-if="search.selected">
                <span style="font-size:12px; color:gray;">{@ search.selected.instance @}</span>
              </div>
              <div style="margin-top:10px;">
                <span @click="searchByPrefix()" v-if="!search.end" style="float:left;
                  cursor: pointer; color: blue;
                  border: solid 1px blue;
                  border-radius: 4px; padding: 4px;">
                  {{ t('investigation.new.show_more') }}...
                </span>
                <span v-if="search.selected" @click="confirmSelection()" style="float:right;
                  cursor: pointer; color: green;
                  border: solid 1px green;
                  border-radius: 4px; padding: 4px;">
                  {{ t('investigation.new.confirm') }}
                </span>
              </div>
          </div>
        </div>

      </template>

    </div>

{% endblock %}
